@page "/Persons/{id:int}/Edit"
@page "/Persons/{id:int}/Edit/{countryId:int}"
@page "/Persons/{id:int}/EditGroup/{groupId:int}"

@attribute [Authorize(Policy = "User")]

@inject IStringLocalizer<App> Localizer
@inject IToastService ToastService
@inject NavigationManager Navigator

@inject PersonService PersonService
@inject UserService UserService
@inject CountryService CountryService
@inject GroupService GroupService

<PageHeading ObjectName="Person" IconClass="@FontAwesome.User" PageAction="@Id.ToAddOrEditPageAction()" HelpContext="Person" />

@if (Person is null)
{

}
else if (Principal.IsAuthorisedInCountry(Person.CountryId))
{
    <EditTemplate Item="@Person" OnValidSubmit="OnValidSumbit">
        <Inputs>
            <AppInputText Width="2" Label="FirstName" @bind-Value="Person.FirstName" />
            <AppInputText Width="2" Label="MiddleName" @bind-Value="Person.MiddleName" />
            <AppInputText Width="2" Label="LastName" @bind-Value="Person.LastName" />
            <AppInputText Width="2" Label="CityName" @bind-Value="Person.CityName" />
            <AppInputSelect Width="2" Label="Country" @bind-Value="Person.CountryId" Items="CountriesItems" ShowPleaseSelect="true" />
            <AppInputText Width="2" Label="FremoPrefix" @bind-Value="Person.FremoOwnerSignature" />

            <AppInputText Width="6" Label="EmailAddresses" @bind-Value="Person.EmailAddresses" />
            <AppInputText Width="12" Label="FremoReservedAdresses" @bind-Value="Person.FremoReservedAdresses" Placeholder="LocoAddressExample" />
            @if (Principal.IsAnyAdministrator() && User is not null)
            {
                <AppInputCheck Width="3" Label="IsGlobalAdministrator" @bind-Value="User.IsGlobalAdministrator" IsDisabled="!IsSelfAsGlobalAdministrator" />
                <AppInputCheck Width="3" Label="IsCountryAdministrator" @bind-Value="User.IsCountryAdministrator" IsDisabled="IsNotGlobalAdministrator"/>
                <AppInputCheck Width="3" Label="IsApiAccessPermitted" @bind-Value="User.IsApiAccessPermitted" />
                <AppInputCheck Width="3" Label="MayUploadSkpDrawing" @bind-Value="User.MayUploadSkpDrawing" />
                <AppInputText Width="6" Label="AdministratorAreaOfResposibility" @bind-Value="User.AdministratorAreaOfResposibility" IsDisabled="IsNotAdministrator" />
                <AppInputNumber Width="3" Label="PasswordResetAttempts" @bind-Value="User.PasswordResetAttempts" IsDisabled=true/>
                <AppInputNumber Width="3" Label="FailedLoginAttempts" @bind-Value="User.FailedLoginAttempts" IsDisabled=true/>
            }
        </Inputs>
    </EditTemplate>

    @if (User is not null && User.IsLockedOut()) {
        <br/>
        <h3>@Localizer["UserIsLockedOut"]</h3>
        <AppButton Label="Unlock" OnClickCallback="UnlockUser" />
    }
}
else
{
    <div class="alert alert-danger">
        @Localizer["NotAuthorized"]
    </div>
}
@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    [Parameter] public int Id { get; set; }
    [Parameter] public int CountryId { get; set; }
    [Parameter] public int GroupId { get; set; }

    private Person? Person;
    private User? User;
    private Group? Group;
    private IEnumerable<ListboxItem>? CountriesItems;
    private ClaimsPrincipal? Principal;

    protected async override Task OnParametersSetAsync()
    {
        Principal = await AuthenticationStateTask.GetClaimsPrincipalAsync();
        CountriesItems = await CountryService.ListboxItemsAsync(Principal, IsGroupAdministrator);
        Person = await GetOrCreatePersonAsync();
        if (Person.UserId > 0) User = await UserService.FindByIdAsync(Person.UserId.Value);
        if (GroupId > 0) Group = await GroupService.FindByIdAsync(Principal, GroupId);
    }

    private async Task OnValidSumbit()
    {
        if (Principal is null || Person is null) return;
        var result = await PersonService.SaveAsync(Principal, Person, IsGroupAdministrator);
        if (User is not null)  User = await UserService.UpdateAsync(User);
        if (result.Count < 1)
        {
            ToastService.ShowSuccessOrFailure(Localizer, result.Count, result.Message);
        }
        else
        {
            Person = result.Entity;
            if (IsNotGroupMember)
            {
                var addresult = await GroupService.AddMemberAsync(Principal, new GroupMember { GroupId = GroupId, PersonId = Person!.Id });
            }
            ToastService.ShowSuccessOrFailure(Localizer, result.Count, result.Message);
            await Task.Delay(3000);
            Navigator.NavigateTo(AfterSaveHref);
        }

    }

    async Task UnlockUser() {
        if (User is not null) {
            User.FailedLoginAttempts = 0;
            User.PasswordResetAttempts = 0;
            await UserService.UpdateAsync(User);
        }
    }

    private bool IsGroupAdministrator => Group is not null && Group.GroupMembers.Any(gm => gm.PersonId == Principal.PersonId() && gm.IsGroupAdministrator);

    private async Task<Person> GetOrCreatePersonAsync() =>
        Principal is null || Id == 0 ? DefaultPerson : await PersonService.FindByIdAsync(Principal, Id) ?? DefaultPerson;

    private int DefaultCountryId => CountryId > 0 ? CountryId : Principal is not null ? Principal.CountryId() : CountriesItems is null ? 0 : CountriesItems.Count() == 1 ? CountriesItems.First().Id : 0;
    private Person DefaultPerson => new Person { CountryId = DefaultCountryId };
    private string AfterSaveHref => GroupId > 0 ? $"Groups/{GroupId}/Members" : $"/Persons/Country/{CountryId}";
    private bool IsNotGroupMember => GroupId > 0 && (Person is null || !Person.GroupMembers.Any(gm => gm.GroupId == GroupId));
    private bool IsNotGlobalAdministrator => !Principal.IsGlobalAdministrator();
    private bool IsSelfAsGlobalAdministrator => Principal.IsGlobalAdministrator() && Principal.UserId() == User?.Id;
    private bool IsNotAdministrator => User is null || !(User.IsCountryAdministrator || User.IsGlobalAdministrator);
}