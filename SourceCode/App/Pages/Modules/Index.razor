@page "/Modules/Index"
@page "/Modules/Country/{countryId:int}"

@attribute [Authorize(Policy = "User")]
@inject IStringLocalizer<App> Localizer
@inject NavigationManager Navigator

@inject ModuleService ModuleService
@inject CountryService CountryService


<PageHeading ObjectName="Modules" IconClass="@FontAwesome.Modules" PageAction="@PageAction.List" />

<ListboxSelector OnSelected="OnSelectedCountry" Items="Countries" ItemType="Country" IsVisible="IsSelectCountryVisible" SelectedId=CountryId />

<TableTemplate Items="Modules">
    <TableHeader>
        <th>@Localizer["Scale"]</th>
        <th>@Localizer["Name"]</th>
        <th align="center">@Localizer["Status"]</th>
        <th>@Localizer["IsPartOfStation"]</th>
        <th>@Localizer["Standard"]</th>
        <th>@Localizer["Owners"]</th>
        @if (Principal.IsAnyAdministrator())
        {
            <th>@Localizer["Actions"]</th>
        }
    </TableHeader>
    <RowTemplate Context="module">
        <td>1:@module.Scale.Denominator</td>
        <td>@module.FullName</td>
        <td>@module.StatusIcon()</td>
        <td>@module.StationName()</td>
        <td>@module.Standard.ShortName</td>
        <td>@module.OwnerNames()</td>
        @if (Principal.IsAnyAdministrator())
        {
            <td><AppButton Label="Edit" Href="@EditHref(module)" IsDisabled="(!MayEdit(module))" /></td>
        }
    </RowTemplate>
</TableTemplate>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    [Parameter] public int CountryId { get; set; }

    private ClaimsPrincipal? Principal;
    private IEnumerable<Module>? Modules;
    private IEnumerable<ListboxItem>? Countries;

    private void OnSelectedCountry(int id)
    {
        if (id > 0)
        {
            CountryId = id;
            Navigator.NavigateTo($"/Modules/Country/{id}");
        }

    }

    private bool IsSelectCountryVisible => Countries is not null && Countries.Count() > 1;
    private bool MayEdit(Module module) => Principal.IsGlobalAdministrator() || module.OwningPersonsIds().Contains(Principal.PersonId());


    protected async override Task OnInitializedAsync()
    {
        Principal = await AuthenticationStateTask.GetClaimsPrincipalAsync();
        Countries = await CountryService.ListboxItemsAsync(Principal);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (CountryId < 1)
        {
            CountryId= Principal.CountryId();
            Navigator.NavigateTo($"/Modules/Country/{CountryId}");
        }
        else
        {
            Modules = await ModuleService.GetAllInCountryAsync(Principal, CountryId);
        }
    }

    string EditHref(Module? module) =>
        module is null ? string.Empty :
        module.IsGroupOwned() ? $"/Modules/{module.Id}/Edit/GroupOwned/{module.OwningGroupId()}" :
        $"/Modules/{module.Id}/Edit/PersonOwned/{module.OwningPersonsIds()[0]}";

}
