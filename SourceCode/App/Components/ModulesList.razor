@inject IStringLocalizer<App> Localizer
@inject IToastService ToastService

@inject ModuleService ModuleService

@preservewhitespace true

@if (Modules is not null && MayEdit)
{
    <div>
        <a class="btn btn-sm btn-secondary" href="@ModuleEditHref(0)"><span class="fa fa-plus-square" />@Localizer["Add"]</a>
    </div>
}

<TableTemplate Items="Modules">
    <TableHeader>
        <th>@Localizer["Name"]</th>
        <th>@Localizer["FremoName"]</th>
        <th>@Localizer["Scale"]</th>
        <th>@Localizer["Standard"]</th>
        <th>@Localizer["Owners"]</th>
        <th>@Localizer["IsStation"]</th>
        <th>@Localizer["Actions"]</th>
    </TableHeader>
    <RowTemplate Context="module">
        <td>@module.FullName</td>
        <td>@module.FremoName()</td>
        <td>@module.Scale.ShortName</td>
        <td>@module.Standard.ShortName</td>
        <td>@Owners(module.ModuleOwnerships)</td>
        <td>@((module.IsPartOfStation()).AsYesNo())</td>
        <td>
            @if (MayEdit)
            {
                <a class="btn btn-sm btn-primary" href="@ModuleEditHref(module.Id)"><span class="fa fa-edit" />@Localizer["Edit"]</a>
                @if (module.StationId.HasValue)
                {
                    <a class="btn btn-sm btn-secondary" href="@StationEditHref(module.StationId.Value)"><span class="fa fa-school" />@Localizer.EditObject("Station")</a>
                }
                @if (module.Id > 0)
                {
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="(() => Clone(module.Id))"><span class="fa fa-clone" />@Localizer["Clone"]</button>
                }
            }
            &nbsp;
        </td>
    </RowTemplate>
</TableTemplate>

@code {
    [Parameter] public IEnumerable<Module>? Modules { get; set; }
    [Parameter] public bool MayEdit { get; set; }
    [Parameter] public int OwningPersonId { get; set; }
    [Parameter] public int OwningGroupId { get; set; }
    [Parameter] public ClaimsPrincipal? Principal { get; set; }
    private string Owners(IEnumerable<ModuleOwnership>? owners) => owners is null ?
        string.Empty :
        string.Join(", ", owners.Select(o => o.Group is not null ? $"{o.Group.FullName}" : o.Person is not null ? $"{o.Person.FirstName} {o.Person.LastName}" : string.Empty));

    async Task Clone(int id)
    {
        var ownerRef = OwningGroupId > 0 ? ModuleOwnershipRef.Group(OwningGroupId) : ModuleOwnershipRef.Person(OwningPersonId);
        var result = await ModuleService.CloneAsync(Principal, id, ownerRef);
        ToastService.ShowSuccessOrFailure(Localizer, result.Count, result.Message);
        Modules = await ModuleService.GetAllAsync(Principal, ownerRef);
    }

    bool HasFremoNumber(Module module) => module.FremoNumber.HasValue;
    string ModuleEditHref(int id) => OwningGroupId > 0 ?
        $"/Modules/{id}/Edit/GroupOwned/{OwningGroupId}" :
        $"/Modules/{id}/Edit/PersonOwned/{OwningPersonId}";
    string StationEditHref(int id) => OwningGroupId > 0 ?
        $"/Stations/{id}/Edit/GroupOwned/{OwningGroupId}" :
        $"/Stations/{id}/Edit/PersonOwned/{OwningPersonId}";

}
